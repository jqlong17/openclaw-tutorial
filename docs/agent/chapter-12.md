# 第 12 章：Agent 运行器

> 本章将讲解 OpenClaw 中 Agent 的运行机制，包括生命周期、提示词工程和上下文处理。

---

## 12.1 Agent 是什么？

### 12.1.1 从"程序"到"Agent"

**传统程序**：
- 按照固定的逻辑执行
- 输入确定，输出确定
- 比如：计算器输入 1+1，永远输出 2

**Agent**：
- 有自己的"性格"和"记忆"
- 能理解上下文，做出灵活响应
- 比如：你问"今天怎么样？"，它会根据时间、你的历史对话给出不同回答

**类比理解**：
- **传统程序** = 自动售货机：投币 → 选商品 → 出货（固定流程）
- **Agent** = 服务员：能听懂你的需求，灵活推荐，记住你的喜好

### 12.1.2 Agent 的核心组成

一个完整的 Agent 包含：

| 组件 | 作用 | 类比 |
|------|------|------|
| **大脑（AI 模型）** | 理解、推理、生成回复 | 服务员的大脑 |
| **记忆（Memory）** | 记住对话历史、用户信息 | 服务员的记事本 |
| **工具（Tools）** | 执行具体操作 | 服务员的工具（POS机、菜单） |
| **人格（Persona）** | 定义性格和行为方式 | 服务员的态度和风格 |
| **上下文（Context）** | 当前对话的背景信息 | 服务员知道的当前情况 |

---

## 12.2 Agent 的生命周期

### 12.2.1 从启动到运行

**阶段一：初始化（出生）**

Agent 启动时，会做以下准备工作：

1. **加载配置**
   - 读取配置文件（模型选择、参数设置）
   - 检查必要的文件和目录

2. **加载人格**
   - 读取 SOUL.md（我是谁）
   - 读取 IDENTITY.md（我的基本信息）
   - 构建系统提示词（告诉 AI 如何表现）

3. **初始化记忆**
   - 连接记忆数据库
   - 加载长期记忆

4. **注册工具**
   - 加载内置工具（文件操作、网络请求等）
   - 加载自定义工具

5. **预热连接**
   - 测试与 AI 模型的连接
   - 确保一切就绪

**阶段二：运行（工作）**

初始化完成后，Agent 进入消息处理循环：

```
等待消息 → 接收消息 → 处理消息 → 生成回复 → 发送回复
    ↑                                              ↓
    └──────────────── 循环 ────────────────────────┘
```

**阶段三：关闭（休息）**

当需要关闭时：
- 保存当前状态
- 关闭数据库连接
- 清理资源

### 12.2.2 消息处理流程

**当你发送一条消息时，发生了什么？**

**第一步：接收消息**
- 从 Discord/Telegram/飞书等平台接收消息
- 解析消息内容（文字、图片等）
- 提取发送者信息

**第二步：预处理**
- 过滤垃圾信息
- 检查是否需要响应（比如被 @提及才回复）
- 格式化消息内容

**第三步：构建上下文**
- 获取对话历史（最近几条消息）
- 加载相关记忆（之前聊过的内容）
- 准备系统提示词（告诉 AI 怎么回答）

**第四步：调用 AI 模型**
- 把所有信息发给 AI 模型
- AI 模型理解内容并生成回复
- 可能需要多次调用（比如先思考，再回答）

**第五步：执行工具（如果需要）**
- 如果用户要求查天气，调用天气工具
- 如果要求发邮件，调用邮件工具
- 工具执行结果返回给 AI

**第六步：生成最终回复**
- AI 根据工具结果生成最终回答
- 格式化回复内容

**第七步：发送回复**
- 把回复发送给用户
- 记录到记忆系统

**整个过程示例**：

> 你：明天北京天气怎么样？
> 
> Agent 内部处理：
> 1. 接收：解析出文字内容
> 2. 预处理：判断需要响应
> 3. 上下文：加载对话历史
> 4. AI 调用：理解意图（查询天气）
> 5. 工具执行：调用天气 API
> 6. 生成回复："明天北京晴朗，15-22°C"
> 7. 发送：把回复发给你

---

## 12.3 提示词工程

### 12.3.1 什么是提示词？

**提示词（Prompt）** 就是给 AI 的指令，告诉它：
- 你是谁
- 你要做什么
- 怎么回答问题

**类比**：就像给新员工的工作手册

### 12.3.2 系统提示词

**系统提示词** 是 Agent 的"基本设定"，每次对话都会带上。

**包含内容**：

1. **身份定义**
   > 你是 OpenClaw AI 助手，一个智能、友善的助手。

2. **能力说明**
   > 你可以帮助用户：
   > - 回答技术问题
   > - 执行系统命令
   > - 管理文件和日程

3. **行为准则**
   > - 回答要简洁明了
   > - 不确定时诚实说明
   > - 尊重用户隐私

4. **格式要求**
   > - 使用 Markdown 格式
   > - 代码块标注语言
   > - 重要信息用粗体

**这些设定来自哪里？**

- **SOUL.md**：定义性格、价值观、行为方式
- **IDENTITY.md**：定义基本信息、能力范围
- **USER.md**：了解用户偏好

### 12.3.3 动态提示词

除了固定的系统提示词，还可以根据情况动态添加：

**示例 1：根据时间**

早上：
> 现在是早上 9 点，用户可能刚开始工作。

晚上：
> 现在是晚上 10 点，用户可能在休息。

**示例 2：根据用户状态**

新用户：
> 这是新用户，需要更多引导和帮助。

老用户：
> 这是老用户，可以更简洁地回答。

**示例 3：根据对话历史**

如果之前讨论过某个话题：
> 之前你们讨论过 Python，用户有一定基础。

---

## 12.4 上下文处理

### 12.4.1 为什么需要上下文？

**没有上下文的问题**：

> 你：北京天气怎么样？
> Bot：北京今天晴朗，25°C。
> 你：那明天呢？
> Bot：？？？（不知道你在问哪个城市）

**有上下文的情况**：

> 你：北京天气怎么样？
> Bot：北京今天晴朗，25°C。
> 你：那明天呢？
> Bot：北京明天多云，22°C。（知道还是问北京）

### 12.4.2 上下文的组成

**上下文包括**：

| 类型 | 内容 | 作用 |
|------|------|------|
| **对话历史** | 最近的几条消息 | 理解当前话题 |
| **长期记忆** | 之前的重要信息 | 记住用户偏好 |
| **系统信息** | 时间、用户信息 | 提供背景 |
| **工具结果** | 刚才查询的数据 | 基于事实回答 |

### 12.4.3 上下文窗口管理

**什么是上下文窗口？**

AI 模型能处理的文字长度有限（比如 4000 个词），这就是"上下文窗口"。

**问题**：
- 对话太长，装不下怎么办？
- 怎么选择保留哪些内容？

**解决方案**：

1. **滑动窗口**
   - 只保留最近的 N 条消息
   - 旧的消息丢弃

2. **智能筛选**
   - 保留重要的信息
   - 丢弃闲聊内容

3. **摘要总结**
   - 把长对话总结成几句话
   - 既节省空间，又保留关键信息

**示例**：

原始对话（10 条消息）：
> 用户：你好
> Bot：你好！有什么可以帮你的？
> 用户：我想学 Python
> Bot：太好了！Python 是很好的编程语言。
> 用户：从哪里开始？
> Bot：建议从基础语法开始...
> （中间讨论了很多细节）
> 用户：好的，我去试试
> Bot：加油！有问题随时问我。
> 用户：谢谢

摘要后（2 条消息）：
> 【之前讨论】用户想学习 Python，已推荐基础语法教程
> 用户：谢谢

### 12.4.4 多轮对话处理

**什么是多轮对话？**

不是一问一答，而是连续的、有关联的多轮交流。

**示例**：

> 你：帮我订个闹钟
> Bot：好的，几点？
> 你：明天早上 7 点
> Bot：好的，明天早上 7 点的闹钟已设置。
> 你：再订一个 7 点半的
> Bot：明天早上 7 点半的闹钟也已设置。

**处理技巧**：

1. **跟踪对话状态**
   - 当前在哪个话题？
   - 等待用户提供什么信息？

2. **处理指代**
   - "再订一个" → 知道还是指闹钟
   - "明天" → 知道是相对于今天

3. **保持连贯**
   - 语气一致
   - 信息不矛盾

---

## 12.5 本章小结

### 核心要点

1. **Agent 是什么**
   - 有性格、有记忆的智能程序
   - 能灵活响应，不是固定逻辑

2. **生命周期**
   - 初始化：加载配置、人格、记忆、工具
   - 运行：接收 → 处理 → 回复的循环
   - 关闭：保存状态，清理资源

3. **提示词工程**
   - 系统提示词：定义基本设定
   - 动态提示词：根据情况调整
   - 来源：SOUL.md、IDENTITY.md、USER.md

4. **上下文处理**
   - 对话历史、长期记忆、系统信息
   - 上下文窗口有限，需要智能管理
   - 多轮对话需要跟踪状态

### 类比总结

| 概念 | 类比 | 作用 |
|------|------|------|
| Agent | 服务员 | 服务用户 |
| 生命周期 | 上班流程 | 准备 → 工作 → 下班 |
| 提示词 | 工作手册 | 告诉 AI 怎么做 |
| 上下文 | 记事本 | 记住当前情况 |
| 记忆 | 客户档案 | 记住用户信息 |

### 下一步

在下一章，我们将学习 **工具系统**：
- Agent 如何调用外部工具
- 工具的类型和注册
- 如何创建自定义工具

---

## 参考资源

- OpenClaw Agent 配置文档
- 提示词工程最佳实践
- 上下文管理策略
