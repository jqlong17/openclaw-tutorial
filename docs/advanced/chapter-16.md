# 第 16 章：定时任务系统

> 本章将讲解 OpenClaw 的定时任务系统，包括 Cron 表达式、任务类型和使用场景。

---

## 16.1 什么是定时任务？

### 16.1.1 生活中的定时任务

**闹钟**：每天早上 7 点响，叫你起床

**定时器**：煮鸡蛋 8 分钟，时间到自动提醒

**日程提醒**：每周三下午 2 点开会，提前 15 分钟提醒

**自动任务**：
- 每天晚上自动备份手机照片
- 每周自动清理垃圾文件
- 每月自动还信用卡

### 16.1.2 程序中的定时任务

**什么是定时任务？**

定时任务就是让程序在**指定的时间**自动执行**指定的操作**。

**不需要人工干预**：
- 不用手动点击
- 不用一直盯着
- 到时间就自动执行

**类比理解**：

- **普通程序** = 手动闹钟：你需要自己看时间，到了手动按铃
- **定时任务** = 自动闹钟：设定好时间，到点自动响

---

## 16.2 Cron 表达式

### 16.2.1 什么是 Cron？

**Cron** 是一种时间表达方式，用简单的符号表示复杂的执行时间。

**基本格式**：

```
分钟 小时 日期 月份 星期
```

**五个位置**：

| 位置 | 含义 | 范围 |
|------|------|------|
| 第1位 | 分钟 | 0-59 |
| 第2位 | 小时 | 0-23 |
| 第3位 | 日期 | 1-31 |
| 第4位 | 月份 | 1-12 |
| 第5位 | 星期 | 0-7（0和7都是周日）|

### 16.2.2 常用表达式示例

**每天执行**：

| 表达式 | 含义 |
|--------|------|
| `0 9 * * *` | 每天上午 9:00 |
| `0 0 * * *` | 每天午夜 12:00 |
| `30 14 * * *` | 每天下午 2:30 |

**每周执行**：

| 表达式 | 含义 |
|--------|------|
| `0 9 * * 1` | 每周一上午 9:00 |
| `0 10 * * 5` | 每周五上午 10:00 |
| `0 0 * * 0` | 每周日午夜 |

**每月执行**：

| 表达式 | 含义 |
|--------|------|
| `0 9 1 * *` | 每月 1 日上午 9:00 |
| `0 0 15 * *` | 每月 15 日午夜 |

**间隔执行**：

| 表达式 | 含义 |
|--------|------|
| `*/5 * * * *` | 每 5 分钟 |
| `0 */2 * * *` | 每 2 小时 |
| `0 9-17 * * 1-5` | 工作日 9:00-17:00 每小时 |

### 16.2.3 特殊符号

| 符号 | 含义 | 示例 |
|------|------|------|
| `*` | 任意值 | `* * * * *` = 每分钟 |
| `,` | 列表 | `1,3,5` = 1、3、5 |
| `-` | 范围 | `1-5` = 1 到 5 |
| `/` | 步进 | `*/5` = 每隔 5 |

**示例解析**：

```
0 9 * * 1-5
│ │ │ │ │
│ │ │ │ └── 星期：周一到周五
│ │ │ └──── 月份：每个月
│ │ └────── 日期：每天
│ └──────── 小时：9点
└────────── 分钟：0分

含义：工作日（周一到周五）每天上午9点执行
```

---

## 16.3 OpenClaw 的定时任务

### 16.3.1 两种任务类型

**类型一：系统事件（System Event）**

向系统发送消息，触发某些操作。

**使用场景**：
- 定时发送提醒
- 触发工作流
- 执行系统命令

**示例**：
> 每天早上 9 点发送早报：
> "📰 早上好！今日待办事项：..."

**类型二：Agent 执行（Agent Turn）**

让 AI Agent 在指定时间执行任务。

**使用场景**：
- 定时生成报告
- 定时检查状态
- 定时发送总结

**示例**：
> 每周五下午 5 点生成周报：
> "请总结本周的工作进展和下周计划"

### 16.3.2 执行环境

**主会话（Main Session）**：
- 在主会话中执行
- 可以访问当前对话上下文
- 适合与用户交互的任务

**隔离会话（Isolated Session）**：
- 在独立会话中执行
- 不影响当前对话
- 适合后台任务

**如何选择？**

| 场景 | 推荐环境 | 原因 |
|------|---------|------|
| 发送提醒 | 主会话 | 用户能看到 |
| 生成报告 | 隔离会话 | 后台执行，不打扰 |
| 数据备份 | 隔离会话 | 不需要用户参与 |
| 定时查询 | 主会话 | 结果展示给用户 |

### 16.3.3 时区设置

**为什么需要时区？**

你的服务器可能在国外，但你想按北京时间执行任务。

**设置方法**：

在配置中指定时区：
> 时区：Asia/Shanghai（北京时间）

**常用时区**：

| 时区 | 说明 |
|------|------|
| Asia/Shanghai | 北京时间 |
| Asia/Tokyo | 东京时间 |
| America/New_York | 纽约时间 |
| Europe/London | 伦敦时间 |
| UTC | 协调世界时 |

---

## 16.4 实际应用场景

### 16.4.1 每日早报

**场景**：每天早上自动发送社区数据

**配置**：
- 时间：每天 9:00
- 类型：Agent 执行
- 提示词："生成昨日社区数据简报"

**效果**：
> 📰 **社区早报**
> 
> 📊 昨日数据：
> • 新成员：+15 人
> • 活跃讨论：42 条
> • 解决问题：8 个
> 
> 🔥 热门话题：
> 1. 如何配置多平台接入
> 2. 新功能预览

### 16.4.2 定期清理

**场景**：每周自动清理过期数据

**配置**：
- 时间：每周日凌晨 3:00
- 类型：系统事件
- 操作：清理 30 天前的临时文件

**效果**：
- 自动归档旧线程
- 删除过期日志
- 整理缓存文件

### 16.4.3 定时提醒

**场景**：重要事件提醒

**配置**：
- 时间：每周五 17:00
- 类型：系统事件
- 消息："别忘了提交周报哦！"

**效果**：
> ⏰ **提醒**
> 
> 别忘了提交周报哦！
> 
> [查看周报模板] [提交周报]

### 16.4.4 数据同步

**场景**：定时同步外部数据

**配置**：
- 时间：每小时
- 类型：Agent 执行
- 提示词："检查并同步最新的项目数据"

**效果**：
- 自动拉取 GitHub 更新
- 同步外部 API 数据
- 更新统计数据

---

## 16.5 最佳实践

### 16.5.1 任务设计原则

**原则一：任务要具体**

❌ 不好的设计：
> "定时处理一些事情"

✅ 好的设计：
> "每天早上9点发送昨日数据报告"

**原则二：时间要合理**

❌ 不好的设计：
> 每 1 分钟执行一次（太频繁）

✅ 好的设计：
> 每小时执行一次（合理频率）

**原则三：考虑时区**

❌ 不好的设计：
> 服务器在 UTC 时间 9 点执行（用户在北京时间 17 点才收到）

✅ 好的设计：
> 设置为 Asia/Shanghai 时区，北京时间 9 点执行

### 16.5.2 错误处理

**任务失败怎么办？**

1. **重试机制**
   - 失败后自动重试 3 次
   - 间隔 5 分钟

2. **错误通知**
   - 发送错误提醒给管理员
   - 记录错误日志

3. **降级处理**
   - 部分失败时继续执行其他任务
   - 不影响整体系统

### 16.5.3 监控和维护

**需要监控的内容**：

| 指标 | 说明 | 正常范围 |
|------|------|---------|
| 执行成功率 | 任务成功执行的比例 | > 95% |
| 平均执行时间 | 任务完成所需时间 | < 预期时间 |
| 延迟情况 | 是否按时执行 | 误差 < 1 分钟 |

**定期维护**：
- 检查任务执行日志
- 清理不再需要的任务
- 优化执行时间（避开高峰期）

---

## 16.6 本章小结

### 核心要点

1. **什么是定时任务**
   - 在指定时间自动执行操作
   - 不需要人工干预

2. **Cron 表达式**
   - 分钟 小时 日期 月份 星期
   - 使用特殊符号表示复杂时间

3. **OpenClaw 定时任务**
   - 系统事件：发送消息、触发操作
   - Agent 执行：让 AI 定时工作
   - 主会话 vs 隔离会话

4. **应用场景**
   - 每日早报、定期清理、定时提醒、数据同步

5. **最佳实践**
   - 任务要具体、时间要合理、考虑时区
   - 错误处理和监控

### Cron 表达式速查表

| 需求 | 表达式 |
|------|--------|
| 每分钟 | `* * * * *` |
| 每小时 | `0 * * * *` |
| 每天 9 点 | `0 9 * * *` |
| 每周一 9 点 | `0 9 * * 1` |
| 每月 1 日 9 点 | `0 9 1 * *` |
| 工作日每小时 | `0 9-17 * * 1-5` |

### 下一步

在下一章，我们将学习 **插件系统**：
- 如何扩展 OpenClaw 功能
- 插件的开发和使用
- 插件生态

---

## 参考资源

- Cron 表达式在线测试工具
- 时区转换工具
- OpenClaw 定时任务配置文档
